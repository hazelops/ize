name: "Tests: E2E"
defaults:
  run:
    shell: bash

env:
  AWS_REGION: us-east-1
  ENV: testnut
  NAMESPACE: nutcorp
  AWS_PROFILE: default
  SSH_PUBLIC_KEY: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDzpzhdXGr0ULtBivzXBkuW+sh233KqSqNIaHF8WQciJ2cufdZSO2M9khSkSNnogoP6oI5RgkB4pwtcLRiCmQteVGikbpYT5/R4wbASxq4lJlqdw1NxMQjthZR95/RESn4S5/IpIpUv2xmisNydyRpcyeDoc3TiEt+1CYjlAycsEYGN4pRze0EFxiqIwMKizmsl1FcG0egADFWgQCuAOM9re2OVoQH3UqgXKjHSRLGlz0m+NHHY8FOIuBzHTtKzi2jv8WgDg70K+L5v2HebB9sL3ncAlAS44FSy+9RqFck4x+f6qRO02VLphFjPV7ro4I7GoYBOTMEz+7LiQHxtQIyWPC3Ty10ZtZsTc+GTNqQCHbN05M1pqDLaTZy2NBNdI9Rn08SiHiQmoiNa0d0FW2vlVYoXs2sQFyvHFPnd0ZJ+uS3n4hSomM+LV+x0SG4xM05cs+5q+EkKbDGIDq4ThixrZTkBKewLc/ubmaC2pwCPJJH4hbuWXR9msjOVOX2FGgs= testnut"

on:
  workflow_dispatch:

jobs:
  build:
    name: Build
    strategy:
      matrix:
        os:
          - ubuntu-latest
# TODO: re-enable other platforms after Ubuntu is working fine
#          - macos-latest
#          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x

      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Build
        run: |
          go mod download
          make bin

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ize-${{ matrix.os }}-${{ github.sha }}
          path: ${{ github.workspace }}/ize

  ecs-apps-monorepo:
    name: ECS Apps Monorepo
    needs: build
    strategy:
      max-parallel: 1
      matrix:
        os:
          - ubuntu-latest
#          - windows-latest
#          - macos-latest
    runs-on: ${{ matrix.os }}
    env:
      ENV: test-ecs-apps
    steps:
      - name: Configure PATH
        run: |
          echo "${{ github.workspace }}/bin/" >> $GITHUB_PATH

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x

      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Prepare Test Environment
        run: mv "${{ github.workspace }}/examples/${{ github.job }}/.ize/env/testnut" "${{ github.workspace }}/examples/${{ github.job }}/.ize/env/${{ env.ENV }}"

      - uses: actions/download-artifact@v3
        with:
          name: ize-${{ matrix.os }}-${{ github.sha }}
          path: bin

      - name: Make Executable
        run: |
          chmod +rx "${{ github.workspace }}/bin/ize"
          ize --version

      - name: Create AWS Profile
        run: ize gen aws-profile

      - name: Generate SSH Key
        run: ssh-keygen -q -f ~/.ssh/id_rsa

#      - name: Install SSH key
#        uses: shimataro/ssh-key-action@v2
#        with:
#          key: ${{ env.SSH_PUBLIC_KEY }}
#          name: id_rsa.pub
#          known_hosts: unnecessary
#          if_key_exists: replace

      - name: Run Tests
        run: |
          go test -v --timeout 0 --tags="e2e ecs_apps" ./test-e2e | tee ecs-monorepo-results.json
        env:
          IZE_EXAMPLES_PATH: ${{ github.workspace }}/examples/${{ github.job }}

  bastion-tunnel-monorepo:
    name: Bastion tunnel monorepo
    needs: build
    strategy:
      max-parallel: 1
      matrix:
        os:
          - ubuntu-latest
# TODO: re-enable other platforms after Ubuntu is working fine
#          - windows-latest
#          - macos-latest
    runs-on: ${{ matrix.os }}
    env:
      ENV: bastion-tunnel
    steps:
      - name: Configure PATH
        run: |
          echo "${{ github.workspace }}/bin/" >> $GITHUB_PATH

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x

      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Prepare Test Environment
        run: mv "${{ github.workspace }}/examples/${{ github.job }}/.ize/env/testnut" "${{ github.workspace }}/examples/${{ github.job }}/.ize/env/${{ env.ENV }}"

      - uses: actions/download-artifact@v3
        with:
          name: ize-${{ matrix.os }}-${{ github.sha }}
          path: bin

      - name: Make Executable
        run: |
          chmod +rx "${{ github.workspace }}/bin/ize"
          ize  --version

      - name: Create AWS Profile
        run: ize gen aws-profile

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ env.SSH_PUBLIC_KEY }}
          name: id_rsa.pub
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Run Tests
        run: |
          go test -v --timeout 0 --tags="e2e bastion_tunnel" ./test-e2e
        env:
          IZE_EXAMPLES_PATH: ${{ github.workspace }}/examples/${{ github.job }}

  terraform-commands:
    name: Terraform Commands
    needs: build
    strategy:
      max-parallel: 1
      matrix:
        os:
          - ubuntu-latest
# TODO: re-enable other platforms after Ubuntu is working fine
#          - macos-latest
#          - windows-latest

    runs-on: ${{ matrix.os }}
    env:
      ENV: test-terraform
    steps:
      - name: Configure PATH
        run: |
          echo "${{ github.workspace }}/bin/" >> $GITHUB_PATH

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x

      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Prepare Test Environment
        run: mv "${{ github.workspace }}/examples/ecs-apps-monorepo/.ize/env/testnut" "${{ github.workspace }}/examples/ecs-apps-monorepo/.ize/env/${{ env.ENV }}"

      - uses: actions/download-artifact@v3
        with:
          name: ize-${{ matrix.os }}-${{ github.sha }}
          path: bin

      - name: Make Executable
        run: |
          chmod +rx "${{ github.workspace }}/bin/ize"
          ize --version

      - name: Create AWS Profile
        run: ize gen aws-profile

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ env.SSH_PUBLIC_KEY }}
          name: id_rsa.pub
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Run Tests
        run: |
          go test -v --timeout 0 --tags="e2e terraform" ./test-e2e
        env:
          IZE_EXAMPLES_PATH: ${{ github.workspace }}/examples/ecs-apps-monorepo

  install-terraform-version:
    name: Install Terraform Version
    needs: build
    strategy:
      matrix:
        terraform_version:
          - 1.0.10
          - 1.1.3
          - 1.1.7
          - 1.2.7
        os:
          - ubuntu-latest
# TODO: re-enable other platforms after Ubuntu is working fine
#          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Configure PATH
        run: |
          echo "${{ github.workspace }}/bin/" >> $GITHUB_PATH

      - uses: actions/download-artifact@v3
        with:
          name: ize-${{ matrix.os }}-${{ github.sha }}
          path: bin

      - name: Make Executable
        run: |
          chmod +rx "${{ github.workspace }}/bin/ize"
          ize --version

      - name: "Check if Terraform Version is installable ${{ matrix.terraform_version }}"
        run: |
          cd ${{ github.workspace }}/examples/bastion-tunnel-monorepo
          ize gen aws-profile
          ize --terraform-version=${{ matrix.terraform_version }} terraform -version
